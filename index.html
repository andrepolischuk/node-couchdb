<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Node-couchdb by villadora</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Node-couchdb</h1>
        <p class="header">An extendable couch client lib for nodejs</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/villadora/node-couchdb/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/villadora/node-couchdb/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/villadora/node-couchdb">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/villadora">villadora</a></p>


      </header>
      <section>
        <h1>
<a name="node-couchdb-client" class="anchor" href="#node-couchdb-client"><span class="octicon octicon-link"></span></a>Node Couchdb Client</h1>

<p>There are already many couchdb client in npm, and some of them are great projects, like <a href="https://github.com/dscape/nano">nano</a>, <a href="https://github.com/flatiron/cradle">cradle</a>, but still not implements the couchdb features that satisfied my needs in auth, view operations and flexibility. Some libs has fewer apis and failed to meet needs. Even some are not complete yet or not friendly to use. </p>

<p>There is always arguments that whether we really need a library for couchdb as it has rest apis. To me, if I'm working on a small project that read/write some documents from couchdb, I'm happy to work with http request lib like <a href="mikeal/request">request</a>. </p>

<p>But when your applications heavily depends on couch, you may want something that make code better orgnized rather than concating url strings in everywhere.</p>

<ul>
<li><a href="#features">Features</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#documentations">Documentations</a></li>
<li><a href="#license">License</a></li>
</ul><h2>
<a name="features" class="anchor" href="#features"><span class="octicon octicon-link"></span></a>Features</h2>

<ul>
<li>Extendable via bind, to build your own apis</li>
<li>Support view, lists and shows</li>
<li>Chain for query paramters, easy and clean</li>
<li>All the concepts (View, Document, etc.) are seperated, which make this lib support urls that get rewritted</li>
<li>Treat DesignDoc the same as Document, you can do operations on DesignDoc</li>
<li>Support Https, via request</li>
</ul><h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<pre><code>npm install couch-db --save
</code></pre>

<h2>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h2>

<h4>
<a name="create-a-couch-server" class="anchor" href="#create-a-couch-server"><span class="octicon octicon-link"></span></a>Create a couch server</h4>

<div class="highlight highlight-js"><pre><span class="kd">var</span> <span class="nx">couch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'couch-db'</span><span class="p">),</span>
    <span class="nx">server</span> <span class="o">=</span> <span class="nx">couch</span><span class="p">(</span><span class="s1">'http://localhost:5984'</span><span class="p">);</span>
<span class="c1">/// or </span>
<span class="nx">server</span> <span class="o">=</span> <span class="nx">couch</span><span class="p">(</span><span class="s1">'https://localhost:6984'</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">rejectUnauthorized</span><span class="o">:</span> <span class="kc">false</span> <span class="c1">// this will pass to request</span>
<span class="p">});</span>
</pre></div>

<p>Or</p>

<div class="highlight highlight-js"><pre><span class="kd">var</span> <span class="nx">CouchDB</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'couch-db'</span><span class="p">).</span><span class="nx">CouchDB</span><span class="p">;</span>
    <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CouchDB</span><span class="p">(</span><span class="s1">'http://localhost:5984'</span><span class="p">);</span>
</pre></div>

<h4>
<a name="authenticate-with-username--password" class="anchor" href="#authenticate-with-username--password"><span class="octicon octicon-link"></span></a>Authenticate with username &amp;&amp; password</h4>

<div class="highlight highlight-js"><pre><span class="nx">server</span><span class="p">.</span><span class="nx">auth</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">);</span>
</pre></div>

<h4>
<a name="or-you-can-utilize-the-session-by-login" class="anchor" href="#or-you-can-utilize-the-session-by-login"><span class="octicon octicon-link"></span></a>Or you can utilize the session by login</h4>

<div class="highlight highlight-js"><pre><span class="nx">server</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do admin ops</span>
    <span class="p">....</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">logout</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// final work</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<h4>
<a name="get-a-database" class="anchor" href="#get-a-database"><span class="octicon octicon-link"></span></a>Get a database</h4>

<div class="highlight highlight-js"><pre><span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">database</span><span class="p">(</span><span class="s1">'couch'</span><span class="p">);</span>
</pre></div>

<p>Or using bind:</p>

<div class="highlight highlight-js"><pre><span class="nx">server</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'couch'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">couch</span><span class="p">;</span>

<span class="c1">// destroy</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="s1">'couch'</span><span class="p">);</span>
</pre></div>

<h4>
<a name="you-can-extend-database" class="anchor" href="#you-can-extend-database"><span class="octicon octicon-link"></span></a>You can extend database</h4>

<div class="highlight highlight-js"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
   <span class="c1">// read documents by page</span>
   <span class="nx">page</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">limit</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
       <span class="c1">// Don't use skip/limit do page on views, see http://docs.couchdb.org/en/1.5.x/couchapp/views/pagination.html#views-pagination</span>
       <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">().</span><span class="nx">skip</span><span class="p">((</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nx">limit</span><span class="p">).</span><span class="nx">limit</span><span class="p">(</span><span class="nx">limit</span><span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultLimit</span><span class="p">).</span><span class="nx">exec</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
   <span class="p">},</span>
   <span class="nx">defaultLimit</span><span class="o">:</span> <span class="mi">20</span>
<span class="p">});</span>


<span class="nx">db</span><span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// get page items</span>
<span class="p">});</span>
</pre></div>

<h4>
<a name="create-database-and-insert-new-doc" class="anchor" href="#create-database-and-insert-new-doc"><span class="octicon octicon-link"></span></a>Create database and insert new doc</h4>

<div class="highlight highlight-js"><pre><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'couch-db'</span><span class="p">)(</span><span class="s1">'http://localhost:5984'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">database</span><span class="p">(</span><span class="s1">'test'</span><span class="p">);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// create a new database</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// insert a document with id 'jack johns'</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">'jack johns'</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'jack'</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'insertion failed '</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
            <span class="c1">// body will like following:</span>
            <span class="c1">//   { ok: true,</span>
            <span class="c1">//     id: 'jack johns',</span>
            <span class="c1">//     rev: '1-610953b93b8bf1bae12427e2de181307' }</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<h3>
<a name="create-new-document-with-attachments" class="anchor" href="#create-new-document-with-attachments"><span class="octicon octicon-link"></span></a>create new document with attachments</h3>

<div class="highlight highlight-javascript"><pre><span class="c1">// new document</span>
<span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">testdb</span><span class="p">.</span><span class="nx">doc</span><span class="p">({});</span>
<span class="nx">doc</span><span class="p">.</span><span class="nx">attach</span><span class="p">([{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">'place.css'</span><span class="p">,</span>
    <span class="nx">content_type</span><span class="o">:</span> <span class="s1">'text/css'</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="s1">'body { font-size: 12px; }'</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">'script.js'</span><span class="p">,</span>
    <span class="nx">content_type</span><span class="o">:</span> <span class="s1">'script/javascript'</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="s1">'window.onload(function() {})'</span>
<span class="p">}]).</span><span class="nx">create</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

<span class="p">});</span>

</pre></div>

<h3>
<a name="addretrieveupdate-attachment" class="anchor" href="#addretrieveupdate-attachment"><span class="octicon octicon-link"></span></a>add/retrieve/update attachment</h3>

<div class="highlight highlight-javascript"><pre><span class="c1">// existing document</span>
<span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">testdb</span><span class="p">.</span><span class="nx">doc</span><span class="p">({</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="s1">'docid'</span>
<span class="p">});</span>

<span class="c1">// open to get revision or assign revision to the document</span>
<span class="nx">doc</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="s1">'plain.css, '</span><span class="nx">body</span> <span class="p">{</span> <span class="nx">font</span><span class="o">-</span><span class="nx">size</span><span class="o">:</span><span class="mi">12</span><span class="nx">pt</span><span class="p">;</span> <span class="p">}</span><span class="s1">', '</span><span class="nx">text</span><span class="o">/</span><span class="nx">css</span><span class="s1">');</span>
<span class="s1">    // save the doc</span>
<span class="s1">    doc.save(function(err, rs) {</span>
<span class="s1">        var plain = doc.attachment('</span><span class="nx">plain</span><span class="p">.</span><span class="nx">txt</span><span class="s1">');</span>
<span class="s1">        // retrieve attachment</span>
<span class="s1">        plain.get(function(err, body) {</span>
<span class="s1">            assert.equal(body, '</span><span class="nx">body</span> <span class="p">{</span> <span class="nx">font</span><span class="o">-</span><span class="nx">size</span><span class="o">:</span><span class="mi">12</span><span class="nx">pt</span><span class="p">;</span> <span class="p">}</span><span class="s1">');</span>
<span class="s1">            // update</span>
<span class="s1">            plain.update('</span><span class="nx">body</span> <span class="p">{</span> <span class="nx">font</span><span class="o">-</span><span class="nx">size</span><span class="o">:</span><span class="mi">14</span><span class="nx">pt</span><span class="p">;</span> <span class="p">}</span><span class="s1">', '</span><span class="nx">text</span><span class="o">/</span><span class="nx">css</span><span class="s1">', function(err) {</span>
<span class="s1">                plain.get(function(err, body) {</span>
<span class="s1">                    assert.equal(body, '</span><span class="nx">body</span> <span class="p">{</span> <span class="nx">font</span><span class="o">-</span><span class="nx">size</span><span class="o">:</span><span class="mi">14</span><span class="nx">pt</span><span class="p">;</span> <span class="p">}</span><span class="err">'</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<h3>
<a name="add-attachments-with-pipe" class="anchor" href="#add-attachments-with-pipe"><span class="octicon octicon-link"></span></a>add attachments with pipe</h3>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">addAttachment</span><span class="p">(</span><span class="s1">'logo.png'</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">'image/png'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">d</span><span class="p">)</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s1">'Failed to create connect stream'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'./logo.png'</span><span class="p">)).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
<span class="nx">s</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
</pre></div>

<h2>
<a name="documentations" class="anchor" href="#documentations"><span class="octicon octicon-link"></span></a>Documentations</h2>

<p>See <a href="http://villadora.github.io/node-couchdb">here</a> for more detail documentations.</p>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>(The BSD License)</p>

<pre><code>Copyright (c) 2014, Villa.Gao &lt;jky239@gmail.com&gt;;
All rights reserved.
</code></pre>
      </section>
      <footer>
        <p><small>Hosted on <a href="http://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
